<!DOCTYPE html>
<html>
	<head>
		<title>Epiphyte Corp.</title>
		
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<meta name="viewport" content="width = device-width, initial-scale = 1, user-scalable = no" />

		<script src="http://cdnjs.cloudflare.com/ajax/libs/coffee-script/1.7.1/coffee-script.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/howler/1.1.17/howler.min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.marionette/2.2.2/backbone.marionette.min.js"></script>
		<style>

			html, body {
				background-color: #EEE5C3;
				margin: 0;
				padding: 0;
			}

			.indicator-view {
				width: 10px;

			}
			.numpad-view {
				max-width: 300px;
				margin: 0 auto;
				padding: .75em;
				list-style: none;
				overflow: auto;
			}

			.numpad-view li {
				margin-right: 1.5%;
				margin-bottom: 1.5%;
				width: 32%;
				box-sizing: border-box;
				float: left;
				position: relative;
				overflow: hidden;
				max-width: 6em;
			}

			.numpad-view li a {
				display: block;
				text-align: center;
				height: 100%;
				background-color: #EBE1E1;
				width: auto;
				padding: 1em;
				box-sizing: border-box;
				text-decoration: none;
				color: #333;
				font-size: 1.8em;
				font-family: monospace;
				position: relative;
				top: 5px;
				left: 5px;
				right: -10px;
				transition: top .035s ease-in;
				box-shadow: -1px 3px 3px rgba(0,0,0,0.1);
				text-shadow: -1px -1px 0px rgba(0, 0, 0, 0.1), 1px 1px 0px rgba(255, 255, 255, 1);
				min-height: 4.6em;
			}

			.numpad-view li a .alpha,
			.numpad-view li a .number {
				display: block;
			}

			.numpad-view li a .alpha {
				font-size: 0.7em;
				color: #666;
			}
			.numpad-view li a .number {
				margin: 0.3em;
			}

			.numpad-view li a:after {
				content: '';
				position: absolute;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
				border-bottom: 11px solid #B6B5B5;
			}

			.numpad-view li a:before {
				content: '';
				position: absolute;
				overflow: hidden;
				top: 0.5em;
				bottom: 1em;
				left: .5em;
				right: .5em;
				border-radius: 75%;
				background-color: transparent;
				box-shadow: inset 0 15px 20px 5px rgba(0,0,0,0.03);
			}

			.numpad-view li a:active {
				top: 10px;
			}

			

			.numpad-view li:nth-child(3n+1) {
				clear: left;
			}
			.numpad-view li:nth-child(3n) {
				margin-right: 0;
			}
		</style>
	</head>
	<body>


		<script type="text/coffeescript">

			class State extends Backbone.Model
				initialize: ({ @url, @repeatDelay, @actions }) ->

			class Player extends Backbone.Model
				initialize: ({state, @states}) ->
					if state
						@state = new State( @states[state] )
						return

					throw new Error('No state provided to Player!')

				play: ->
					@_createSound() unless @sound
					console.log "playing state: ", @state
					console.log "available actions: ", @state.actions
					@sound.play()

				stop: ->
					@sound.stop()

				setState: (state) ->
					console.log "changing state to: #{ state }.", @states
					@state = new State( @states[state] )
					@_createSound()
					@play()
						
				_createSound: =>
					@sound = new Howl
						urls: [@state.url]
						onend: =>
							if @state.repeatDelay
								setTimeout ( => 
									console.log "repeating sound after #{ @state.repeatDelay } miliseconds."
									@sound.play() 
								), @state.repeatDelay
						volume: 1

			class InputController extends Backbone.Model
				initialize: ({ @player }) ->
				handleInput: (value) ->
					actions = @player.state.actions
					@player.stop()
					@player.setState( actions[value] ) if actions?[value]


			class IndicatorView extends Marionette.ItemView
				tagName: 'div'
				className: 'indicator-view'
				template: _.template ""


			class AppView extends Marionette.LayoutView
				className: 'app-view'
				template: _.template """
					<div class="indicator-region"></div>
					<div class="numpad-region"></div>
				"""
				regions:
					indicatorRegion: '.indicator-region'
					numpadRegion: '.numpad-region'

				initialize: ->
					@numpadView = new NumpadView()
					@indicatorView = new IndicatorView()
					@player = new Player
						state: 'start'
						states:
							start:
								url:'assets/start.mp3'
								repeatDelay: 5000
								actions:
									"1": 'general'
									"2": 'start'
									"2": 'options'
							hold:
								url:'assets/hold.mp3'
								repeatDelay: 5000

							yournumber:
								url:'assets/yournumber.mp3'
								repeatDelay: 5000
								actions:
									"9": 'start'
							general:
								url:'assets/general.mp3'
								repeatDelay: 5000
								actions:
									"1": 'hold'
									"2": 'yournumber'
									"9": 'hold'
							options:
								url:'assets/options.mp3'
								repeatDelay: 5000
								actions:
									"1": 'options'
									"9": 'start'
							recent:
								url:'assets/recent.mp3'
								repeatDelay: 5000
								actions:
									"1": 'hold'
									"2": 'start'

					@inputController = new InputController( player: @player )

					@listenTo @numpadView, 'press', (value) =>
						console.log "pressed #{value}"
						@inputController.handleInput( value )
					
					@listenTo @numpadView, 'done:ring', =>
						console.log "done ringing"
						@player.setState( 'start' )

				onShow: ->
					@numpadRegion.show( @numpadView )
					@indicatorRegion.show( @indicatorView )
					



			class NumpadView extends Marionette.ItemView
				tagName: 'ol'
				className: 'numpad-view'
				template: _.template """
					<li>
						<a href="#">
							<span class="alpha"></span>
							<span class="number">1</span>
						</a>
					</li>
					<li>
						<a href="#">
							<span class="alpha">ABC</span>
							<span class="number">2</span>
						</a>
					</li>
					<li>
						<a href="#">
							<span class="alpha">DEF</span>
							<span class="number">3</span>
						</a>
					</li>
					<li>
						<a href="#">
							<span class="alpha">GHI</span>
							<span class="number">4</span>
						</a>
					</li>
					<li>
						<a href="#">
							<span class="alpha">JFK</span>
							<span class="number">5</span>
						</a>
					</li>
					<li>
						<a href="#">
							<span class="alpha">MNO</span>
							<span class="number">6</span>
						</a>
					</li>
					<li>
						<a href="#">
							<span class="alpha">PQRS</span>
							<span class="number">7</span>
						</a>
					</li>
					<li>
						<a href="#">
							<span class="alpha">TUV</span>
							<span class="number">8</span>
						</a>
					</li>
					<li>
						<a href="#">
							<span class="alpha">WXYZ</span>
							<span class="number">9</span>
						</a>
					</li>
					<li>
						<a href="#">
							<span class="alpha"></span>
							<span class="number">*</span>
						</a>
					</li>
					<li>
						<a href="#">
							<span class="alpha">+</span>
							<span class="number">0</span>
						</a>
					</li>
					<li>
						<a href="#">
							<span class="alpha"></span>
							<span class="number">#</span>
						</a>
					</li>
				"""

				initialize: ->
					@beepSound = new Howl
						urls: ['sfx/beep2.mp3']
						sprite:
							short: [0, 100]
							medium: [0, 1500]
							long: [0, 3000]
						volume: 1

					@ringSound = new Howl
						urls: ['sfx/ringing.mp3']
						volume: 1
						sprite:
							short: [0, 5000]
							medium: [0, 10000]
							long: [0, 30000]
						onend: =>
							@trigger( 'done:ring' )
						
					@clickSound = new Howl
						urls: ['sfx/click.mp3']
						volume: 1

				events:
					'click li': '_handlePressButton'

				_handlePressButton: (ev) ->
					$item = $( ev.target )
					@clickSound.play()
					@beepSound.play( 'short' )
					@trigger "press", $item.find('.number').html()

				onShow: ->
					@ringSound.play( 'short' )

			appRegion = new Marionette.Region( el: $('body')[0] )
			appView = new AppView()

			$ -> appRegion.show( appView )

			

			

		</script>
		
	</body>
</html>